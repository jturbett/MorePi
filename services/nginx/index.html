<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üõ∞Ô∏è MorePi Container Dashboard</title>

  <style>
    .background--custom {
      background: linear-gradient(90deg, #A512D3, #202A50, #A56E97);
      background-size: 300% 300%;
      animation: gradient 8s alternate infinite;
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      z-index: -1;
    }
    @keyframes gradient {
      0% { background-position: 0%; }
      100% { background-position: 100%; }
    }

    body {
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      color: #fff;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 3rem;
      backdrop-filter: blur(3px);
    }
    h1 { color: #fff; margin: 1rem 0 1rem 0; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      width: 100%;
      max-width: 1000px;
      padding: 1rem;
    }
    .button {
      border-radius: 12px;
      padding: 1.2rem;
      font-size: 1.1rem;
      text-align: center;
      color: #fff;
      transition: all 0.25s ease;
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,0.2);
    }
    .svc-name { font-weight: 600; }
    .svc-status { margin-top: 0.4rem; font-size: 0.9rem; opacity: 0.9; }
    .svc-status.healthy { color: #9eff9e; }
    .svc-status.unhealthy { color: #ff7a7a; }
    .svc-status.starting { color: #ffe28a; }
    .running { background: rgba(0, 255, 0, 0.25); box-shadow: 0 0 10px #00ff00; }
    .stopped { background: rgba(255, 0, 0, 0.25); box-shadow: 0 0 10px #ff0000; }

    #statusbar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 0.5rem;
      font-size: 1rem;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      z-index: 100;
    }

    footer {
      margin-top: 2rem;
      font-size: 0.85rem;
      color: #e5e7eb;
      opacity: 0.9;
    }

    /* ChatGPT window */
    #chatgpt-box {
      border: 1px solid #444;
      border-radius: 12px;
      padding: 1.2em;
      margin-top: 2em;
      width: 90%;
      max-width: 1200px;   /* wider panel */
      background: rgba(0,128,0,0.6); /* green */
      color: white;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }

    #chatgpt-box h2 { color: white; margin-top: 0; text-align: center; }

    #chat-input {
      resize: vertical;
      width: 100%;
      padding: .6em;
      border-radius: 8px;
      font-size: 1rem;
    }

    #chat-form {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: .5em;
    }

    #chat-form button {
      align-self: flex-end;
      width: 120px;
      padding: .5em;
      border-radius: 8px;
    }

    #chat-history {
      min-height: 250px;
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: .75em;
      background: #fff;
      color: #000;
      margin-top: .5em;
      border-radius: 8px;
    }

    #chat-history strong { color: #007bff; }

    #view-log {
      margin-top: .8em;
      padding: .4em .8em;
      border: none;
      border-radius: 6px;
      background: #007bff;
      color: white;
      cursor: pointer;
      align-self: flex-start;
    }
  </style>
</head>

<body>
  <div class="background--custom"></div>

  <div id="statusbar">
    <span id="time">--:--:--</span>
    <span id="temp">üå°Ô∏è -- ¬∞C</span>
    <span id="load">‚öôÔ∏è Load: --</span>
  </div>

  <h1>üõ∞Ô∏è MorePi Container Dashboard</h1>
  <div class="grid" id="links"></div>

  <div style="display:flex; justify-content:center;">
    <div id="turbattoStatus" style="margin-top:1rem; font-size:1.2rem;">
      üåê Turbatto.com: <span id="turbattoIcon">‚è≥ Checking...</span>
    </div>
  </div>

  <footer>Hosted on MorePi ¬∑ <span id="year"></span> ¬∑ <span id="code-version">Code: loading...</span></footer>

  <!-- ChatGPT Section -->
  <section id="chatgpt-box">
    <h2>üí¨ Ask MorePi</h2>

    <!-- Input area ABOVE output -->
    <form id="chat-form">
      <textarea id="chat-input" rows="3" placeholder="Type your question here..." autocomplete="off" required></textarea>
      <button type="submit">Send</button>
    </form>

    <!-- Output area -->
    <div id="chat-history"></div>

    <!-- History button -->
    <button id="view-log">üìú View Chat History</button>
  </section>

  <script>
    const services = [
      { name: "Home Assistant", port: 8123, id: "homeassistant" },
      { name: "SABnzbd", port: 8080, id: "sabnzbd" },
      { name: "Sonarr", port: 8989, id: "sonarr" },
      { name: "Radarr", port: 7878, id: "radarr" },
      { name: "Readarr", port: 8787, id: "readarr" },
      { name: "Whisparr", port: 6969, id: "whisparr" },
      { name: "Prowlarr", port: 9696, id: "prowlarr" },
      { name: "Grocy", port: 9283, id: "grocy" },
      { name: "BarcodeBuddy", port: 9080, id: "barcodebuddy" },
      { name: "Portainer", port: 9000, id: "portainer" },
      { name: "Graylog", port: 9001, id: "graylog" },
      { name: "Docker Proxy", port: 2375, id: "dockerproxy" },
      { name: "Docker API", port: 9999, id: "dockerapi" },
      { name: "MCP Server", port: 2600, id: "mcp-server" },
      { name: "Nginx", port: 80, id: "nginx" },
      { name: "ChatGPT Web", port: 8080, id: "chatgpt-web" }
    ];

    const grid = document.getElementById("links");
    const host = window.location.hostname;

    services.forEach(svc => {
      const link = document.createElement("a");
      link.href = `http://${host}:${svc.port}`;
      link.target = "_blank";
      link.rel = "noopener noreferrer";
      const div = document.createElement("div");
      div.id = svc.id;
      div.className = "button stopped";
      div.innerHTML = `<div class="svc-name">${svc.name}</div><div class="svc-status">unknown</div>`;
      link.appendChild(div);
      grid.appendChild(link);
    });

    async function updateStatuses() {
      try {
        const res = await fetch("http://192.168.1.55:9999/containers/json?all=1");
        const containers = await res.json();
        const flatNames = containers.map(c => c.Names.map(n => n.replace(/^\/+/, ""))).flat();
        const nameToContainer = new Map();
        containers.forEach(c => {
          c.Names.forEach(n => nameToContainer.set(n.replace(/^\/+/, "").toLowerCase(), c));
        });
        services.forEach(svc => {
          const el = document.getElementById(svc.id);
          if (!el) return;
          const matchName = flatNames.find(n => n.toLowerCase().includes(svc.id.toLowerCase()));
          const container = matchName ? nameToContainer.get(matchName.toLowerCase()) : null;
          const state = container?.State || "unknown";
          const health = container?.Health?.Status || null;
          const isRunning = state === "running";
          el.classList.toggle("running", isRunning);
          el.classList.toggle("stopped", !isRunning);

          const statusEl = el.querySelector(".svc-status");
          if (!statusEl) return;
          statusEl.classList.remove("healthy", "unhealthy", "starting");
          if (health) {
            statusEl.textContent = `health: ${health}`;
            statusEl.classList.add(health);
          } else {
            statusEl.textContent = state;
          }
        });
      } catch (err) { console.error("Docker proxy unreachable:", err); }
    }

    async function updateSystemStatus() {
      try {
        const temp = await (await fetch("/shared/sysinfo/temp")).text();
        const load = await (await fetch("/shared/sysinfo/load")).text();
        document.getElementById("temp").textContent = `üå°Ô∏è ${temp.trim()} ¬∞C`;
        document.getElementById("load").textContent = `‚öôÔ∏è Load: ${load.trim()}`;
      } catch {
        document.getElementById("temp").textContent = "üå°Ô∏è -- ¬∞C";
        document.getElementById("load").textContent = "‚öôÔ∏è Load: --";
      }
    }

    function updateTime() {
      document.getElementById("time").textContent = new Date().toLocaleTimeString();
    }

    async function updateCodeVersion() {
      const versionEl = document.getElementById("code-version");
      if (!versionEl) return;
      try {
        const res = await fetch("/version.json?_=" + Date.now(), { cache: "no-store" });
        if (!res.ok) throw new Error("version.json not found");
        const meta = await res.json();
        const parts = [];
        if (meta.version) parts.push(meta.version);
        if (meta.commit) parts.push(meta.commit);
        if (meta.built_at) parts.push(meta.built_at);
        versionEl.textContent = `Code: ${parts.join(" ¬∑ ") || "unknown"}`;
      } catch (err) {
        versionEl.textContent = "Code: unknown";
        console.warn("Unable to load dashboard version:", err);
      }
    }

    async function checkTurbattoStatus() {
      const icon = document.getElementById("turbattoIcon");
      try {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 5000);
        await fetch("https://turbatto.com", { method: "GET", mode: "no-cors", signal: controller.signal });
        clearTimeout(timeout);
        icon.textContent = "‚úÖ Online"; icon.style.color = "#00ff00";
      } catch {
        icon.textContent = "‚ùå Offline"; icon.style.color = "#ff0000";
      }
    }

    updateStatuses(); setInterval(updateStatuses, 4000);
    updateTime(); setInterval(updateTime, 1000);
    updateSystemStatus(); setInterval(updateSystemStatus, 6000);
    checkTurbattoStatus(); setInterval(checkTurbattoStatus, 15000);
    document.getElementById("year").textContent = new Date().getFullYear();
    updateCodeVersion();

    /* ChatGPT logic */
    const form = document.getElementById('chat-form');
    const input = document.getElementById('chat-input');
    const historyDiv = document.getElementById('chat-history');
    const viewLogBtn = document.getElementById('view-log');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const msg = input.value.trim();
      if (!msg) return;
      historyDiv.innerHTML += `<div><strong>You:</strong> ${msg}</div>`;
      input.value = '';
      historyDiv.scrollTop = historyDiv.scrollHeight;

      try {
        const res = await fetch('/chatgpt/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: msg })
        });
        const data = await res.json();
        const reply = data.response || data.error || 'No response';
        historyDiv.innerHTML += `<div><strong>GPT:</strong> ${reply}</div>`;
      } catch (err) {
        historyDiv.innerHTML += `<div style="color:red;"><strong>Error:</strong> ${err}</div>`;
      }
      historyDiv.scrollTop = historyDiv.scrollHeight;
    });

    viewLogBtn.addEventListener('click', async () => {
      try {
        const today = new Date().toISOString().slice(0,10);
        const res = await fetch(`/chatgpt/logs/chat_${today}.log`);
        if (!res.ok) throw new Error('No log found');
        const text = await res.text();
        const formatted = text.replace(/\n/g, '<br>');
        historyDiv.innerHTML = `<div style="color:#007bff;"><strong>üìú Chat History:</strong></div><div>${formatted}</div>`;
      } catch (err) {
        historyDiv.innerHTML += `<div style="color:red;"><strong>Log error:</strong> ${err}</div>`;
      }
    });
  </script>
<!-- UniFi Protect Events Card -->
<div class="card" id="unifi-card">
  <h3>üé• UniFi Protect Events</h3>
  <div id="unifi-events" class="scrollable"></div>
</div>

<style>
#unifi-card {
  transition: box-shadow 0.3s;
}
#unifi-card.flash {
  box-shadow: 0 0 25px 5px #ff0055;
}
#unifi-events {
  max-height: 200px;
  overflow-y: auto;
  font-family: monospace;
}
.event-item {
  margin: 4px 0;
  opacity: 0;
  transform: translateY(10px);
  animation: slideUp 0.5s forwards;
}
@keyframes slideUp {
  to { opacity: 1; transform: translateY(0); }
}
</style>

<script>
async function loadUniFiEvents() {
  try {
    const res = await fetch("unifi_events.json?_=" + Date.now());
    const events = await res.json();
    const container = document.getElementById("unifi-events");
    container.innerHTML = "";
    for (let ev of events) {
      const t = new Date(ev.time).toLocaleTimeString();
      const color = ev.type === "motion" ? "red" : ev.type === "connect" ? "green" : "gray";
      const row = `<div class='event-item' style='color:${color}'>
        ${t} ‚Äì ${ev.type.toUpperCase()} (${ev.camera})
      </div>`;
      container.innerHTML += row;
    }
    // Flash card for motion
    if (events.some(e => e.type === "motion")) {
      const card = document.getElementById("unifi-card");
      card.classList.add("flash");
      setTimeout(() => card.classList.remove("flash"), 800);
    }
  } catch (err) {
    console.error("Error loading UniFi events:", err);
  }
}
setInterval(loadUniFiEvents, 8000);
loadUniFiEvents();
</script>
<!-- UniFi Protect Events Card -->
<div class="button running" id="unifi-card" style="max-width:700px; margin-top:2rem;">
  <h3 style="margin-top:0;">üé• UniFi Protect Events</h3>
  <div id="unifi-events" class="scrollable"></div>
</div>

<style>
#unifi-card {
  transition: box-shadow 0.3s, transform 0.3s;
  padding: 1rem;
}
#unifi-card.flash {
  box-shadow: 0 0 25px 5px #ff0055;
  transform: scale(1.02);
}
#unifi-events {
  max-height: 200px;
  overflow-y: auto;
  font-family: monospace;
  text-align: left;
  padding: 0.5rem;
}
.event-item {
  margin: 4px 0;
  opacity: 0;
  transform: translateY(10px);
  animation: slideUp 0.5s forwards;
}
@keyframes slideUp {
  to { opacity: 1; transform: translateY(0); }
}
</style>

<script>
async function loadUniFiEvents() {
  try {
    const res = await fetch("/shared/unifi_events.json?_=" + Date.now());
    if (!res.ok) throw new Error("No JSON found");
    const events = await res.json();
    const container = document.getElementById("unifi-events");
    container.innerHTML = "";
    for (let ev of events.slice().reverse()) {
      const t = ev.time || new Date().toLocaleTimeString();
      const color =
        ev.type === "motion" ? "#ff5f5f" :
        ev.type === "connect" ? "#4fff4f" :
        ev.type === "disconnect" ? "#ffaa00" :
        "#ccc";
      const row = `<div class='event-item' style='color:${color}'>
        ${t} ‚Äì ${ev.type.toUpperCase()} (${ev.camera})
      </div>`;
      container.innerHTML += row;
    }
    // Flash card for motion
    if (events.some(e => e.type === "motion")) {
      const card = document.getElementById("unifi-card");
      card.classList.add("flash");
      setTimeout(() => card.classList.remove("flash"), 800);
    }
  } catch (err) {
    console.error("Error loading UniFi events:", err);
  }
}
setInterval(loadUniFiEvents, 8000);
loadUniFiEvents();
</script>

</body>
</html>
